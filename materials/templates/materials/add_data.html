{% extends 'materials/base.html' %}

{% block body %}
  <div class="card card-default">
    <div class="card-header">
      <h4>Add Data</h4>
    </div>
    <div class="card-body">
      {% load materials_tags %}
      <ul class="nav nav-tabs" id="new-data-tab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="data-tab" data-toggle="tab"
             href="#results" role="tab">
            Add new results
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="new-property-tab" data-toggle="tab"
             href="#properties" role="tab">
            Define new property
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="new-unit-tab" data-toggle="tab"
             href="#units" role="tab">
            Define new unit
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="new-unit-tab" data-toggle="tab"
             href="#unsorted" role="tab">
            Other
          </a>
        </li>
      </ul>
      <div class="tab-content" id="add-results-tab-content">
        <!-- ADD NEW RESULTS -->
        <div class="tab-pane show active" id="results" role="tabpanel">
          <br>
          <form method="post" action="{% url 'materials:submit_data' %}"
                enctype="multipart/form-data">
            {% csrf_token %}
            <!-- GENERAL -->
            <div class="card card-item">
              <div class="card-header">
                General
              </div>
              <div class="card-body card-add-data">
                <div class="form-row">
                  <div class="form-group col-md-6">
                    {% include 'materials/input_field.html' with field=form.select_reference %}
                  </div>
                  <div class="form-group col-md-6">
                    {% include 'materials/input_field.html' with field=form.select_system %}
                  </div>
                  <div class="form-group col-md-6">
                    {% include 'materials/input_field.html' with field=form.data_set_label %}
                  </div>
                  <div class="form-group col-md-6">
                    {% include 'materials/input_field.html' with field=form.extraction_method %}
                  </div>
                  <div class="from-group col-md-4">
                    {% include 'materials/input_field.html' with field=form.primary_property %}
                  </div>
                  <div class="from-group col-md-2">
                    {% include 'materials/input_field.html' with field=form.primary_unit %}
                  </div>
                  <div class="from-group col-md-4">
                    {% include 'materials/input_field.html' with field=form.secondary_property %}
                  </div>
                  <div class="from-group col-md-2">
                    {% include 'materials/input_field.html' with field=form.secondary_unit %}
                  </div>
                </div>
                <hr>
                <div class="form-check form-check-inline">
                  {% include 'materials/input_field.html' with field=form.is_figure %}
                </div>
                <div class="form-check form-check-inline">
                  {% include 'materials/input_field.html' with field=form.visible_to_public %}
                </div>
                <div class="form-check form-check-inline">
                  {% include 'materials/input_field.html' with field=form.two_axes %}
                </div>
                <hr>
                <div class="form-row">
                  <div class="col-md-6">
                    {% include 'materials/input_field.html' with field=form.origin_of_data %}
                  </div>
                  <div class="col-md-6">
                    {% include 'materials/input_field.html' with field=form.dimensionality_of_the_system %}
                  </div>
                  <div class="col-md-6">
                    {% include 'materials/input_field.html' with field=form.sample_type %}
                  </div>
                  <div class="col-md-6">
                    {% include 'materials/input_field.html' with field=form.crystal_system %}
                  </div>
                </div>
              </div>
            </div>

            <br>

            <!-- SYNTHESIS METHOD -->
            <div class="card card-item">
              <button class="btn text-left" data-toggle="collapse" type="button"
                      id="synthesis-button" data-target="#synthesis-body"
                      style="background:#dce9ff">
                Synthesis method (click to add)
              </button>
              {{ form.with_synthesis_details }}
              <div class="collapse" id="synthesis-body">
                <div class="card-body card-add-data">
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.starting_materials %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.product %}
                    </div>
                  </div>
                  <div class="form-group">
                    {% include 'materials/input_field.html' with field=form.synthesis_description %}
                  </div>
                  <div class="form-group">
                    {% include 'materials/input_field.html' with field=form.synthesis_comment %}
                  </div>
                </div>
              </div>
            </div>

            <br>

            <!-- EXPERIMENTAL DETAILS -->
            <div class="card card-item">
              <button class="btn text-left" data-toggle="collapse" type="button"
                      id="experimental-button" data-target="#experimental-body"
                      style="background:#dce9ff">
                Experimental details (click to add)
              </button>
              {{ form.with_experimental_details }}
              <div class="collapse" id="experimental-body">
                <div class="card-body card-add-data">
                  <div class="form-group">
                    {% include 'materials/input_field.html' with field=form.experimental_method %}
                  </div>
                  <div class="form-group">
                    {% include 'materials/input_field.html' with field=form.experimental_description %}
                  </div>
                  <div class="form-group">
                    {% include 'materials/input_field.html' with field=form.experimental_comment %}
                  </div>
                </div>
              </div>
            </div>

            <br>

            <!-- COMPUTATIONAL DETAILS -->
            <div class="card card-item">
              <button class="btn text-left" data-toggle="collapse" type="button"
                      id="computational-button" data-target="#computational-body"
                      style="background:#dce9ff">
                Computational details (click to add)
              </button>
              {{ form.with_computational_details }}
              <div class="collapse" id="computational-body">
                <div class="card-body card-add-data">
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.code %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.level_of_theory %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.xc_functional %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.k_point_grid %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.level_of_relativity %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.basis_set_definition %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.numerical_accuracy %}
                    </div>
                  </div>
                  <div class="form-group">
                    {% include 'materials/input_field.html' with field=form.computational_comment %}
                  </div>
                </div>
              </div>
            </div>

            <br>

            <!-- DATA -->
            <div class="card card-item">
              <div class="card-header">
                Data set
              </div>
              <div class="card-body card-add-data">
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-inline">
                      <div class="form-group">
                        {{ form.number_of_data_series.label_tag }}
                        <div style="margin-left:3px">
                          {{ form.number_of_data_series.help_text|tooltip }}
                        </div>
                        {{ form.number_of_data_series }}
                      </div>
                      <input type="file" id="import-all-data" class="inputfile">
                      <label for="import-all-data"><i class="fa fa-upload" aria-hidden="true"></i>
                        Import all from file...</label>
                      <i class="fa fa-question-circle tooltip-container" style="margin-left:3px">
                        <span class="tooltiptext">Select to import all data (all series) from a single file. Use the ampersand ("&") as a delimiter between different data series.</span>
                      </i>
                    </div>
                  </div>
                </div>
                <br>
                <div id="data-series"></div>
              </div>
            </div>

            <br>

            <!-- ADDITIONAL DATA -->
            <div class="card card-item">
              <div class="card-header">
                Additional data
              </div>
              <div class="card-body card-add-data">
                {% include 'materials/input_field.html' with field=form.uploaded_files %}
              </div>
            </div>

            <br>

            <div class="float-right">
              <button type="submit" name="submit-results" class="btn btn-primary">
                Submit
              </button>
            </div>

          </form>
        </div>
        <!-- ADD NEW PROPERTY -->
        <div class="tab-pane" id="properties" role="tabpanel">
          <br>
          <form method="post" action="{% url 'materials:add_property' %}">
            {% csrf_token %}
            <label for="property-name">Property name: </label>
            <input id="property-name" name="property-name" type="text" required>
            <br>
            <button type="submit" name="submit-property" class="btn btn-primary">Submit</button>
          </form>
        </div>
        <!-- ADD NEW UNIT -->
        <div class="tab-pane" id="units" role="tabpanel">
          <br>
          <form method="post" action="{% url 'materials:add_unit' %}">
            {% csrf_token %}
            <label for="unit-label">Unit label: </label>
            <input id="unit-label" name="unit-label" type="text" required>
            <br>
            <button type="submit" name="submit-unit" class="btn btn-primary">Submit</button>
          </form>
        </div>
        <!-- UNSORTED -->
        <div class="tab-pane" id="unsorted" role="tabpanel">
          <br>
          <div style="padding-bottom: 10px">
            <label for="list">Select the type of data you wish to add:</label>
          </div>
          <div id="list" class="list-group">
            <a href="{% url 'materials:add_band_structure'%}" class="list-group-item list-group-item-action">
              Band Structure and/or Band Gap
            </a>
          </div>
          <div style="padding-bottom:10px;padding-top:10px">
            <label for="other-list">Other options:</label>
          </div>
          <div id="other-list" class="list-group">
            <a href="{% url 'materials:add_reference'%}" class="list-group-item list-group-item-action">
              Add Reference
            </a>
            <a href="{% url 'materials:add_system'%}" class="list-group-item list-group-item-action">
              Add System
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- data series template -->
  <div class="data-series-template d-none">
    <br>
    <div class="card card-series">
      <div class="card-header"></div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <div class="row">
              <div class="col-md-7">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text">{{ form.series_label.label }}</span>
                  </div>
                  {{ form.series_label }}
                  <i class="fa fa-question-circle fa-2x tooltip-container" style="margin:3px">
                    <span class="tooltiptext">{{ form.series_label.help_text }}</span>
                  </i>
                </div>
              </div>
              <div class="col-md-5">
                <button type="button" class="btn btn-info add-fixed-property"
                        style="margin-bottom:15px">
                  Add fixed property
                </button>
                <i class="fa fa-question-circle fa-2x tooltip-container">
                  <span class="tooltiptext">Click to define a property that was fixed during the experiment or calculation. For example, if a series of band gaps was measured as a function of pressure and temperature was kept constant for the whole series, the temperature value may be inserted here.</span>
                </i>
              </div>
            </div>
            <div class="fixed-properties"></div>
          </div>
          <div class="col-md-4">
            <div class="normal-input">
              {{ form.series_datapoints.label_tag }}
              {{ form.series_datapoints.help_text|tooltip }}
              <div class="float-right">
                <input type="file" id="import-data-file" class="inputfile import-data-file">
                <label for="import-data-file"><i class="fa fa-upload" aria-hidden="true"></i>
                  Import from file...</label>
              </div>
              {{ form.series_datapoints }}
            </div>
            <div class="atomic-structure-input" hidden="true">
              <div class="form-group">
                {{ form.lattice_constant_a.label_tag }}
                {{ form.lattice_constant_a.help_text|tooltip }}
                <div class="float-right">
                  <input type="file" id="import-lattice-parameters"
                         class="inputfile import-lattice-parameters">
                  <label for="import-lattice-parameters"><i class="fa fa-upload" aria-hidden="true"></i>
                    Import from file...</label>
                </div>
                <div class="input-group">
                  {{ form.lattice_constant_a }}
                  {{ form.lattice_constant_b }}
                  {{ form.lattice_constant_c }}
                </div>
              </div>
              <div class="form-group">
                {{ form.lattice_constant_alpha.label_tag }}
                <div class="input-group">
                  {{ form.lattice_constant_alpha }}
                  {{ form.lattice_constant_beta }}
                  {{ form.lattice_constant_gamma }}
                </div>
              </div>
              <div class="form-group">
                {% include 'materials/input_field.html' with field=form.atomic_coordinates %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- end template -->

  <!-- fixed property template -->
  <div class="form-row fixed-property-template d-none">
    <div class="col-md-4 mb-3">
      <label for="fixed_property">Property</label>
      <select id="fixed_property" name="fixed_property" placeholder="--none--"></select>
    </div>
    <div class="col-md-4 mb-3">
      <label for="fixed_unit">Unit</label>
      <select id="fixed_unit" name="fixed_unit" placeholder="--none--"></select>
    </div>
    <div class="col-md-4 mb-3">
      <label for="fixed_value">Fixed value</label>
      <div class="input-group">
        <input class="form-control" name="fixed_value" type="text" maxlength="50" required>
        <div class="input-group-append">
          <button class="close-fixed-property btn btn-danger fa fa-times"
                  type="button" ></button>
        </div>
      </div>
    </div>
  </div>
  <!-- end template -->
{% endblock %}

{% block script %}
  {% load static %}
  <script src="{% static 'materials/javascript/ajax_csrf_setup.js' %}"></script>
  <script src="{% static 'materials/javascript/selectize.js' %}"></script>
  <script>
   // All dropdown menus are filled with data from a JSON request
   function fill_selectize(name, id, initial_value) {
     $.getJSON('/materials/get-dropdown-options/' + name, function(options) {
       $('#' + id).selectize({
         maxOptions: 500,
         sortField: 'text',
         items: [initial_value],
         options: options,
       });
       // Some events can only be triggered once certain dropdowns have loaded
       if (id === 'id_primary_property') {
         document.getElementById('id_primary_property').dispatchEvent(new Event('change'));
         document.getElementById('id_two_axes').dispatchEvent(new Event('change'));
       }
     });
   }
  </script>
  <script>
   // Use selectize on all dropdown menus
   {% for field in form.visible_fields %}
   {% if field.field.widget.input_type == 'select' %}
   fill_selectize('{{ field.name }}', '{{ field.id_for_label }}', {{ field.value|default_if_none:'' }});
   {% endif %}
   {% endfor %}
  </script>
  <script>
   // When entering data with multiple columns, set "Is figure" to true. Do this only once.
   var is_figure_untested = true;
   // Autofill the main input data textarea
   function autofill_data(el) {
     var i_series = $(el).attr('id').split('import-data-file_')[1];
     var form_data = new FormData();
     form_data.append('file', el.files[0]);
     $(el).val('');  // Clear the file list
     $.ajax({
       url: "{% url 'materials:autofill_input_data' %}",
       type: 'POST',
       processData: false,
       contentType: false,
       dataType: 'text',
       data: form_data,
     }).done(function(result) {
       result = result.replace(/\n\r/g, '\n').replace(/\r/g, '\n'); // Windows
       var data = result.split(/&/);
       if (i_series) {
         $('#id_series_datapoints_' + i_series).val(result);
       } else { // fill globally
         for (var i = 1; i <= $('#id_number_of_data_series').val(); i++) {
           $('#id_series_datapoints_' + i).val(data[i-1].replace(/^\n/, ''));
         }
       }
       if (is_figure_untested) {
         // If the are multiple lines and multiple columns, this is likely a figure.
         lines = data[0].split('\n', 2);
         if (lines.length > 1 && lines[0].split(' ').length > 1) {
           var is_figure = document.getElementById('id_is_figure');
           if (!is_figure.checked) {
             is_figure.checked = true;
             is_figure.dispatchEvent(new Event('change'));
           }
         }
         is_figure_untested = false;
       }
     }).fail(function(result) {
       if (!i_series) i_series = 1;
       $('#id_series_datapoints_' + i_series).val(result);
     });
   }
   $('#import-all-data').change(function() {
     if ($('#id_primary_property').find(':selected').text() === 'atomic structure') {
       import_lattice_parameters(this);
     } else {
       autofill_data(this);
     }
   });
  </script>
  <script>
   // Create a new data series
   var counter_fixed = 0;
   function add_series(i_series) {
     // The name and id of each input is appended by _<i_series>
     var copy = document.getElementsByClassName('data-series-template')[0].cloneNode(true);
     copy.classList.remove('d-none', 'data-series-template');
     copy.getElementsByClassName('card-header')[0].innerHTML = 'Series #' + i_series;
     var elements = copy.querySelectorAll('input, textarea');
     for (var i = 0; i < elements.length; i++) {
       elements[i].id += '_' + i_series;
       elements[i].name += '_' + i_series;
     }
     elements = copy.getElementsByTagName('label');
     for (var i = 0; i < elements.length; i++) {
       elements[i].htmlFor += '_' + i_series;
     }
     copy.getElementsByClassName('fixed-properties')[0].id = 'fixed-properties-' + i_series;
     var fixed_prop_btn = copy.getElementsByClassName('add-fixed-property')[0]
     fixed_prop_btn.id += 'add-fixed-property-' + i_series;
     // Add a fixed property
     fixed_prop_btn.addEventListener('click', function() {
       add_fixed_property(i_series, counter_fixed++);
     });
     copy.getElementsByClassName('import-data-file')[0].addEventListener('change', function() {
       autofill_data(this);
     });
     document.getElementById('data-series').appendChild(copy);
   }
   // Create a new set of fixed property fields
   function add_fixed_property(series, counter, prop_initial='', unit_initial='',
                               value_initial='') {
     var copy = document.getElementsByClassName('fixed-property-template')[0].cloneNode(true);
     var suffix = series + '_' + counter;
     var el, name;
     copy.classList.remove('d-none', 'fixed-property-template');
     function edit_id_and_name(type) {
       name = 'fixed_' + type + '_' + suffix;
       el = copy.querySelector('[name="fixed_' + type + '"]');
       el.id = name;
       el.name = name;
     }
     edit_id_and_name('property');
     fill_selectize('property', name, prop_initial);
     edit_id_and_name('unit');
     fill_selectize('unit', name, unit_initial);
     edit_id_and_name('value');
     if (value_initial) {
       copy.querySelector('[name="fixed_value_' + suffix + '"]').value = value_initial;
     }
     // Remove a fixed property
     copy.getElementsByClassName('close-fixed-property')[0].addEventListener('click', function() {
       row = this.parentNode.parentNode.parentNode.parentNode;
       row.parentNode.removeChild(row);
     });
     document.getElementById('fixed-properties-' + series).appendChild(copy);
   }
   var number_of_data_series = document.getElementById('id_number_of_data_series');
   number_of_data_series.addEventListener('change', function() {
     var data_series = document.getElementById('data-series');
     var n_series_current = data_series.children.length;
     var n_series_requested = this.value;
     var n_to_add = n_series_requested - n_series_current;
     if (n_to_add > 0) {
       for (var i = 1; i <= n_to_add; i++) {
         add_series(n_series_current+i);
       }
     }
     if (n_to_add < 0) {
       for (var i = n_to_add; i < 0; i++) {
         data_series.removeChild(data_series.lastChild);
       }
     }
     if (data_series.hasChildNodes()) {
       data_series.firstChild.getElementsByClassName('series-label-class')[0].disabled =
         n_series_requested == 1;
     }
     document.getElementById('import-all-data').disabled = n_series_requested == 0;
   });
   number_of_data_series.dispatchEvent(new Event('change'));
   // Prefill series from a previous instance of the form
   {% for name_counter, label, values in form.get_series %}
   document.getElementById('id_series_label_{{ name_counter }}').value = '{{ label|escapejs }}';
   document.getElementById('id_series_datapoints_{{ name_counter }}').value = '{{ values|escapejs }}';
   {% endfor %}
   // Prefill fixed properties from a previous instance of the form
   {% for series_counter, name_counter, prop, unit, value in form.get_fixed_properties %}
   add_fixed_property({{ series_counter }}, {{ name_counter }},
                      '{{ prop|escapejs }}', '{{ unit|escapejs }}', '{{ value|escapejs }}');
   {% endfor %}
  </script>
  <script>
   // Properties that require input files
   var saved_main_data_placeholder = '';
   $('#id_primary_property').change(function() {
     primary_unit = $(this).parent().next();
     secondary_property = primary_unit.next();
     secondary_unit = secondary_property.next();
     if ($(this).find(':selected').attr('require_input_files') === 'True') {
       primary_unit.hide();
       secondary_property.hide();
       secondary_unit.hide();
       $('.series-datapoints').prop('disabled', true);
       saved_main_data_placeholder = $('.series-datapoints').attr('placeholder');
       $('.series-datapoints').attr('placeholder', '...');
     } else if (saved_main_data_placeholder) {
       primary_unit.show();
       secondary_property.show();
       secondary_unit.show();
       $('.series-datapoints').prop('disabled', false);
       $('.series-datapoints').attr('placeholder', saved_main_data_placeholder);
       saved_main_data_placeholder = '';
     }
   });
  </script>
  <script>
   // Collapsable sections of the input
   function toggleSectionInclusivity(button, hidden_field) {
     $(button).click(function() {
       if ($(hidden_field).val() === 'True') {
         $(hidden_field).val('False');
         $(button).css({'background': '#dce9ff'});
         $(button).html($(button).html().split('remove)')[0] + 'add)');
       } else {
         $(hidden_field).val('True');
         $(button).css({'background': '#f3ebff'});
         $(button).html($(button).html().split('add)')[0] + 'remove)');
       }
     });
   }
   toggleSectionInclusivity('#synthesis-button', '#id_with_synthesis_details');
   toggleSectionInclusivity('#experimental-button', '#id_with_experimental_details');
   toggleSectionInclusivity('#computational-button', '#id_with_computational_details');
  </script>
  <script>
   // Helper function for setting the value and freezing/unfreezing a checkbox
   function set_checkbox(id, value, freeze) {
     var el = document.getElementById(id);
     el.checked = value;
     if (freeze) {
       el.readOnly = true;
       el.onclick = function(event) { event.preventDefault(); };
     } else {
       el.readOnly = false;
       el.onclick = null;
     }
     el.dispatchEvent(new Event('change'));
   }
  </script>
  <script>
   $('#id_two_axes').change(function(event, force_hide=false) {
     if ($(this).is(':checked') && !force_hide) {
       $('#id_secondary_property').parent().show();
       $('#id_secondary_unit').parent().show();
       $('label[for="id_primary_property-selectized"]').html('Primary property (y-axis)');
       $('.series-datapoints').attr('placeholder', 'x1 y1\nx2 y2\n...');
     } else {
       $('#id_secondary_property').parent().hide();
       $('#id_secondary_unit').parent().hide();
       $('label[for="id_primary_property-selectized"]').html('Primary property');
       $('.series-datapoints').attr('placeholder', 'value_1 value_2 ...');
     }
   });
  </script>
  <script>
   // If figure then "Two axes" must be enabled
   var is_figure = document.getElementById('id_is_figure');
   is_figure.addEventListener('change', function() {
     set_checkbox('id_two_axes', this.checked, this.checked);
   });
   is_figure.dispatchEvent(new Event('change'));
  </script>
  <script>
   // Atomic structure specific
   $('#id_primary_property').change(function() {
     var is_atomic_structure =
       $('#id_primary_property').find(':selected').text() === 'atomic structure';
     if (is_atomic_structure) {
       $('.atomic-structure-input').attr('hidden', false);
       $('.normal-input').hide();
       set_checkbox('id_is_figure', false, true);
       set_checkbox('id_two_axes', false, true);
     } else {
       $('.atomic-structure-input').attr('hidden', true);
       $('.normal-input').show();
       set_checkbox('id_is_figure', false, false);
       set_checkbox('id_two_axes', false, false);
     }
     // Make atomic structure related fields required only if this property has been selected
     $('input[name^="lattice_constant_"]').each(function() {
       $(this).prop('required', is_atomic_structure);
     });
     $('textarea[name^="series_datapoints_"]').each(function() {
       $(this).prop('required', !is_atomic_structure);
     });
   });
   function import_lattice_parameters(el) {
     var i_series = $(el).attr('id').split('import-lattice-parameters_')[1];
     var form_data = new FormData();
     form_data.append('file', el.files[0]);
     $(el).val('');  // Clear the file list
     $.ajax({
       url: "{% url 'materials:autofill_input_data' %}",
       type: 'POST',
       processData: false,
       contentType: false,
       dataType: 'text',
       data: form_data,
     }).done(function(response) {
       var a, b, c, alpha, beta, gamma;
       function process_batch(input_data, dest_suffix) {
         lines = input_data.split('\n');
         var aims_format = false;
         for (var i = 0; i < lines.length; i++) {
           if (lines[i].match(/^ *lattice_vector/)) {
             aims_format = true;
             break;
           }
         }
         if (aims_format) {
           // Generate the atomic structure (lattice constants and angles)
           // from lattice vectors
           lattice_vectors = [];
           var regex = /^ *lattice_vector\s+(-?\d+(?:\.\d+)?)\s+(-?\d+(?:\.\d+)?)\s+(-?\d+(?:\.\d+)?)\b/;
           var match_;
           for (var i = 0; i < lines.length; i++) {
             match_ = lines[i].match(regex);
             if (match_) {
               lattice_vectors.push([match_[1], match_[2], match_[3]]);
             }
           }
           function norm(vector) {
             return Math.sqrt(Math.pow(vector[0],2)+Math.pow(vector[1],2)+Math.pow(vector[2],2));
           }
           function get_angle(v1, v2, norm1, norm2) {
             return Math.acos((v1[0]*v2[0]+v1[1]*v2[1]+v1[2]*v2[2])/norm1/norm2)*360/2/Math.PI;
           }
           if (lattice_vectors.length < 3) {
             throw 'Unable to read in three lattice vectors!';
           }
           a = norm(lattice_vectors[0]);
           b = norm(lattice_vectors[1]);
           c = norm(lattice_vectors[2]);
           alpha = get_angle(lattice_vectors[1], lattice_vectors[2], b, c);
           beta = get_angle(lattice_vectors[0], lattice_vectors[2], a, c);
           gamma = get_angle(lattice_vectors[0], lattice_vectors[1], a, b);
         } else {
           // Read the atomic structure directly from an input file
           var nr_reg = /\b([a-z]+)\s+(-?(?:\d+(?:\.\d+)?|\.\d+)(?:\(\d+(?:\.\d+)?\)|\b))/g;
           var matches = [];
           while (matches = nr_reg.exec(input_data)) {
             switch(matches[1]) {
               case 'a': a = matches[2]; break;
               case 'b': b = matches[2]; break;
               case 'c': c = matches[2]; break;
               case 'alpha': alpha = matches[2]; break;
               case 'beta': beta = matches[2]; break;
               case 'gamma': gamma = matches[2]; break;
             }
           }
           input_data = '';
         }
         $('#id_lattice_constant_a_' + dest_suffix).val(a);
         $('#id_lattice_constant_b_' + dest_suffix).val(b);
         $('#id_lattice_constant_c_' + dest_suffix).val(c);
         $('#id_lattice_constant_alpha_' + dest_suffix).val(alpha);
         $('#id_lattice_constant_beta_' + dest_suffix).val(beta);
         $('#id_lattice_constant_gamma_' + dest_suffix).val(gamma);
         $('#id_atomic_coordinates_' + dest_suffix).val(input_data);
       }
       try {
         if (i_series) {
           process_batch(response, i_series);
         } else {
           response = response.replace(/\n\r/g, '\n').replace(/\r/g, '\n'); // Windows
           var data = response.split('&');
           for (var i = 0; i < data.length; i++) {
             if (data[i]) {
               process_batch(data[i].replace(/^\n/, ''), i+1);
             }
           }
         }
       } catch(e) {
         $('#id_atomic_coordinates_1').val(e);
       }
     }).fail(function(response) {
       if (!i_series) i_series = 1;
       $('#id_atomic_coordinates_' + i_series).html(response);
     });
   }
   $('.import-lattice-parameters').change(function() {
     import_lattice_parameters(this);
   });
   // Prefill from a previous instance of the form
   {% for series_counter, a, b, c, alpha, beta, gamma, coordinates in form.get_lattice_parameters %}
   $('#id_lattice_constant_a_{{ series_counter }}').val('{{ a|escapejs }}');
   $('#id_lattice_constant_b_{{ series_counter }}').val('{{ b|escapejs }}');
   $('#id_lattice_constant_c_{{ series_counter }}').val('{{ c|escapejs }}');
   $('#id_lattice_constant_alpha_{{ series_counter }}').val('{{ alpha|escapejs }}');
   $('#id_lattice_constant_beta_{{ series_counter }}').val('{{ beta|escapejs }}');
   $('#id_lattice_constant_gamma_{{ series_counter }}').val('{{ gamma|escapejs }}');
   $('#id_atomic_coordinates_{{ series_counter }}').val('{{ coordinates|escapejs }}');
   {% endfor %}
  </script>
{% endblock %}
