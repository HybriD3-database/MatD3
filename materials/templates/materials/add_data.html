{% extends 'materials/base.html' %}

{% block body %}
  <br>
  <div class="card card-default">
    <div class="card-header">
      <h4>Add Data</h4>
    </div>
    <div class="card-body">
      {% load materials_tags %}
      {% if messages %}
        {% for message in messages %}
          <div class="d-flex">
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
          </div>
        {% endfor %}
      {% endif %}
      <ul class="nav nav-tabs" id="new-data-tab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="data-tab" data-toggle="tab"
             href="#results" role="tab">
            Add new results
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="new-property-tab" data-toggle="tab"
             href="#properties" role="tab">
            Define new property
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="new-unit-tab" data-toggle="tab"
             href="#units" role="tab">
            Define new unit
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="new-unit-tab" data-toggle="tab"
             href="#unsorted" role="tab">
            Other
          </a>
        </li>
      </ul>
      <div class="tab-content" id="add-results-tab-content">
        <!-- ADD NEW RESULTS -->
        <div class="tab-pane show active" id="results" role="tabpanel">
          <br>
          <form method="post" action="{% url 'materials:submit_data' %}"
                enctype="multipart/form-data">
            {% csrf_token %}
            <!-- GENERAL -->
            <div class="card card-item">
              <div class="card-header">
                General
              </div>
              <div class="card-body card-add-data">
                <div class="form-row">
                  <div class="form-group col-md-6">
                    {% include 'materials/input_field.html' with field=form.select_publication %}
                  </div>
                  <div class="form-group col-md-6">
                    {% include 'materials/input_field.html' with field=form.select_system %}
                    </select>
                  </div>
                  <div class="form-group col-md-6">
                    {% include 'materials/input_field.html' with field=form.data_set_label %}
                  </div>
                  <div class="form-group col-md-6">
                    {% include 'materials/input_field.html' with field=form.extraction_method %}
                  </div>
                  <div class="from-group col-md-4">
                    {% include 'materials/input_field.html' with field=form.primary_property %}
                  </div>
                  <div class="from-group col-md-2">
                    {% include 'materials/input_field.html' with field=form.primary_unit %}
                  </div>
                  <div class="from-group col-md-4">
                    {% include 'materials/input_field.html' with field=form.secondary_property %}
                  </div>
                  <div class="from-group col-md-2">
                    {% include 'materials/input_field.html' with field=form.secondary_unit %}
                  </div>
                </div>
                <hr>
                <div class="form-check form-check-inline">
                  {% include 'materials/input_field.html' with field=form.visible_to_public %}
                </div>
                <div class="form-check form-check-inline">
                  {% include 'materials/input_field.html' with field=form.plotted %}
                </div>
                <hr>
                <div class="form-row">
                  <div class="col-md-6">
                    {% include 'materials/input_field.html' with field=form.origin_of_data %}
                  </div>
                  <div class="col-md-6">
                    {% include 'materials/input_field.html' with field=form.dimensionality_of_the_system %}
                  </div>
                  <div class="col-md-6">
                    {% include 'materials/input_field.html' with field=form.sample_type %}
                  </div>
                  <div class="col-md-6">
                    {% include 'materials/input_field.html' with field=form.crystal_system %}
                  </div>
                </div>
              </div>
            </div>

            <br>

            <!-- SYNTHESIS METHOD -->
            <div class="card card-item">
              <button class="btn text-left" data-toggle="collapse" type="button"
                      id="synthesis-button" data-target="#synthesis-body"
                      style="background:#dce9ff">
                Synthesis method (click to add)
              </button>
              {{ form.with_synthesis_details }}
              <div class="collapse" id="synthesis-body">
                <div class="card-body card-add-data">
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.starting_materials %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.product %}
                    </div>
                  </div>
                  <div class="form-group">
                    {% include 'materials/input_field.html' with field=form.synthesis_description %}
                  </div>
                  <div class="form-group">
                    {% include 'materials/input_field.html' with field=form.synthesis_comment %}
                  </div>
                </div>
              </div>
            </div>

            <br>

            <!-- EXPERIMENTAL DETAILS -->
            <div class="card card-item">
              <button class="btn text-left" data-toggle="collapse" type="button"
                      id="experimental-button" data-target="#experimental-body"
                      style="background:#dce9ff">
                Experimental details (click to add)
              </button>
              {{ form.with_experimental_details }}
              <div class="collapse" id="experimental-body">
                <div class="card-body card-add-data">
                  <div class="form-group">
                    {% include 'materials/input_field.html' with field=form.experimental_method %}
                  </div>
                  <div class="form-group">
                    {% include 'materials/input_field.html' with field=form.experimental_description %}
                  </div>
                  <div class="form-group">
                    {% include 'materials/input_field.html' with field=form.experimental_comment %}
                  </div>
                </div>
              </div>
            </div>

            <br>

            <!-- COMPUTATIONAL DETAILS -->
            <div class="card card-item">
              <button class="btn text-left" data-toggle="collapse" type="button"
                      id="computational-button" data-target="#computational-body"
                      style="background:#dce9ff">
                Computational details (click to add)
              </button>
              {{ form.with_computational_details }}
              <div class="collapse" id="computational-body">
                <div class="card-body card-add-data">
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.code %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.level_of_theory %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.xc_functional %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.k_point_grid %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.level_of_relativity %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.basis_set_definition %}
                    </div>
                    <div class="form-group col-md-6">
                      {% include 'materials/input_field.html' with field=form.numerical_accuracy %}
                    </div>
                  </div>
                  <div class="form-group">
                    {% include 'materials/input_field.html' with field=form.computational_comment %}
                  </div>
                </div>
              </div>
            </div>

            <br>

            <!-- DATA -->
            <div class="card card-item">
              <div class="card-header">
                Data series #1
              </div>
              <div class="card-body card-add-data">
                <div class="row">
                  <div class="col-md-8">
                    <div class="form-group">
                      <label for="dataseries-label">Data series label:</label>
                      <i class="fa fa-question-circle tooltip-container">
                        <span class="tooltiptext">Description of the data series (optional). If this is the only series in the set (e.g., the only curve in a figure), providing just the data set label is probably sufficient.</span>
                      </i>
                      <input class="form-control" id="dataseries-label" name="dataseries-label">
                    </div>
                    <div id="fixed-properties">
                    </div>
                    <button type="button" id="add-fixed-property" class="btn btn-info">
                      Add fixed property
                    </button>
                    <i class="fa fa-question-circle fa-2x tooltip-container">
                      <span class="tooltiptext">Click to define a property that was fixed during the experiment or calculation. For example, if a series of band gaps was measured as a function of pressure and temperature was kept constant for the whole series, the temperature value may be inserted here.</span>
                    </i>
                  </div>
                  <div class="col-md-4">
                    <label for="main-data">Values
                      <i class="fa fa-question-circle tooltip-container">
                        <span class="tooltiptext">Insert data points here. These may be a single value, a series of values, or a series of value pairs. The latter applies when there are both primary and secondary properties, in which case the first column has values of the secondary property (x-values) and the second column corresponds to the primary property (y-values). Note: to resize this box, drag from the corner.</span>
                      </i>
                    </label>
                    <div class="float-right">
                      <input type="file" id="input-data-files" name="input-data-files"
                             class="inputfile" multiple>
                      <label for="input-data-files"><i class="fa fa-upload" aria-hidden="true"></i>
                        Import from file..</label>
                    </div>
                    <textarea class="form-control" id="main-data" name="main-data"
                              placeholder="value_1 value_2 ..." style="height:80%"></textarea>
                  </div>
                </div>
              </div>
            </div>

            <br>

            <!-- ADDITIONAL DATA -->
            <div class="card card-item">
              <div class="card-header">
                Additional data
              </div>
              <div class="card-body card-add-data">
                <label for="uploaded-files">Upload files</label>
                <i class="fa fa-question-circle tooltip-container">
                  <span class="tooltiptext">Upload files containing anything that is relevant to the current data set (input files to a calculation, image of the sample, ...). Multiple files can be selected here.</span>
                </i>
                <input type="file" id="uploaded-files" name="uploaded-files" multiple>
              </div>
            </div>

            <br>

            <div class="float-right">
              <button type="submit" name="submit-results" class="btn btn-primary">
                Submit
              </button>
            </div>

          </form>
          <!-- to be copied -->
          <div class="form-row fixed-property-template d-none">
            <div class="col-md-4 mb-3">
              <label for="fixed-property">Property</label>
              <select class="form-control" id="fixed-property" name="fixed-property">
                {% for property in properties %}
                  <option>{{ property.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="fixed-unit">Unit</label>
              <select class="form-control" id="fixed-unit" name="fixed-unit">
                {% for unit in units %}
                  <option>{{ unit.label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="fixed-value">Fixed value</label>
              <div class="input-group">
                <input class="form-control" id="fixed-value" name="fixed-value" type="text"
                       maxlength="20" required>
                <div class="input-group-append">
                  <button class="close-fixed-property btn btn-danger fa fa-times"
                          type="button" ></button>
                </div>
              </div>
            </div>
          </div>
          <!-- end copy -->
        </div>
        <!-- ADD NEW PROPERTY -->
        <div class="tab-pane" id="properties" role="tabpanel">
          <br>
          <form method="post" action="{% url 'materials:add_property' %}">
            {% csrf_token %}
            <label for="property-name">Property name: </label>
            <input id="property-name" name="property-name" type="text" required>
            <br>
            <button type="submit" name="submit-property" class="btn btn-primary">Submit</button>
          </form>
        </div>
        <!-- ADD NEW UNIT -->
        <div class="tab-pane" id="units" role="tabpanel">
          <br>
          <form method="post" action="{% url 'materials:add_unit' %}">
            {% csrf_token %}
            <label for="unit-label">Unit label: </label>
            <input id="unit-label" name="unit-label" type="text" required>
            <br>
            <button type="submit" name="submit-unit" class="btn btn-primary">Submit</button>
          </form>
        </div>
        <!-- UNSORTED -->
        <div class="tab-pane" id="unsorted" role="tabpanel">
          <br>
          <div style="padding-bottom: 10px">
            <label for="list">Select the type of data you wish to add:</label>
          </div>
          <div id="list" class="list-group">
            <a href="{% url 'materials:add_band_structure'%}" class="list-group-item list-group-item-action">
              Band Structure and/or Band Gap
            </a>
          </div>
          <div style="padding-bottom:10px;padding-top:10px">
            <label for="other-list">Other options:</label>
          </div>
          <div id="other-list" class="list-group">
            <a href="{% url 'materials:add_publication'%}" class="list-group-item list-group-item-action">
              Add Publication
            </a>
            <a href="{% url 'materials:add_system'%}" class="list-group-item list-group-item-action">
              Add System
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
  {% load static %}
  <script src="{% static 'materials/javascript/ajax_csrf_setup.js' %}"></script>
  <script src="{% static 'materials/javascript/selectize.js' %}"></script>
  <script>
   /* Use selectize on all dropdown menus */
   {% for field in form.visible_fields %}
   {% if field.field.widget.input_type == 'select' %}
   $('#{{ field.id_for_label }}').selectize({
     maxOptions: 500,
     sortField: 'text',
     {% if field.value %}
     items: [{{ field.value }}],
     {% endif %}
     options: [
       {% for choice in field.field.choices %}
       {value: '{{ choice.0 }}', text: '{{ choice.1|escapejs }}'},
       {% endfor %}
     ],
   });
   {% endif %}
   {% endfor %}
  </script>
  <script>
   /* Add a fixed property */
   var counter_fixed = 0;
   $('#add-fixed-property').click(function(){
     var el = $('.fixed-property-template').clone(true);
     el.removeClass('d-none');
     el.removeClass('fixed-property-template');
     el.find('[name="fixed-property"]').attr('name', 'fixed-property' + counter_fixed);
     el.find('[name="fixed-unit"]').attr('name', 'fixed-unit' + counter_fixed);
     el.find('[name="fixed-value"]').attr('name', 'fixed-value' + counter_fixed);
     $('#fixed-properties').append(el);
     counter_fixed = counter_fixed + 1
   });
   /* Remove a fixed property */
   $('.close-fixed-property').click(function(){
     $(this).parents('.form-row').remove();
   });
  </script>
  <script>
   /* Depending on whether the property is none, set visibility of the
      unit and #main-data placeholder */
   function toggleUnitVisibility(property, unit) {
     $(property).change(function() {
       if ($(property + ' option:selected').attr('value') == "") {
         $(unit).prop('disabled', true);
         if (property == '#id_secondary_property') {
           $('#main-data').attr('placeholder', 'value_1 value_2 ...');
         }
       } else {
         $(unit).prop('disabled', false);
         if (property == '#id_secondary_property') {
           $('#main-data').attr('placeholder', 'x1 y1\nx2 y2\n...');
         }
       }
     });
   }
   toggleUnitVisibility('#id_secondary_property', '#id_secondary_unit');
   toggleUnitVisibility('#id_primary_property', '#id_primary_unit');
  </script>
  <script>
   /* Properties that require input files */
   var saved_main_data_placeholder = '';
   $('#id_primary_property').change(function() {
     primary_unit = $(this).parent().next();
     secondary_property = primary_unit.next();
     secondary_unit = secondary_property.next();
     if ($(this).find(':selected').attr('require_input_files') == 'True') {
       primary_unit.hide();
       secondary_property.hide();
       secondary_unit.hide();
       $('#main-data').prop('disabled', true);
       saved_main_data_placeholder = $('#main-data').attr('placeholder');
       $('#main-data').attr('placeholder', '...');
     } else if (saved_main_data_placeholder) {
       primary_unit.show();
       secondary_property.show();
       secondary_unit.show();
       $('#main-data').prop('disabled', false);
       $('#main-data').attr('placeholder', saved_main_data_placeholder);
       saved_main_data_placeholder = '';
     }
   });
  </script>
  <script>
   /* Autofill the main input data textarea */
   $('#input-data-files').change(function() {
     if ($('#id_primary_property').find(':selected').attr('require_input_files') == 'False') {
       var form_data = new FormData();
       form_data.append('file', this.files[0]);
       $(this).val('');  /* Clear the file list */
       $.ajax({
         url: "{% url 'materials:autofill_input_data' %}",
         type: 'POST',
         processData: false,
         contentType: false,
         dataType: 'text',
         data: form_data,
         success: function(result) {
           $('#main-data').html(result);
         },
         error: function(result) {
           $('#main-data').html(result);
         },
       });
     } else {
       $('#main-data').html('');
     }
   });
  </script>
  <script>
   function toggleSectionInclusivity(button, hidden_field) {
     $(button).click(function() {
       if ($(hidden_field).val() == 'True') {
         $(hidden_field).val('False');
         $(button).css({'background': '#dce9ff'});
         $(button).html($(button).html().split('remove)')[0] + 'add)');
       } else {
         $(hidden_field).val('True');
         $(button).css({'background': '#f3ebff'});
         $(button).html($(button).html().split('add)')[0] + 'remove)');
       }
     });
   }
   toggleSectionInclusivity('#synthesis-button', '#id_with_synthesis_details');
   toggleSectionInclusivity('#experimental-button', '#id_with_experimental_details');
   toggleSectionInclusivity('#computational-button', '#id_with_computational_details');
  </script>
{% endblock %}
