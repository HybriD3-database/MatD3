<!--
     Contents of class="card-body" corresponding to a data set. Not
     all sections are included by default. This file should be
     included using the "with ..." syntax to include certain parts.
-->
{% load materials_tags %}

<div class="card-body">
  <!-- MAIN DATA -->
  <h5>{{ dataset.label }}</h5>
  {% if dataset.primary_property.name == 'lattice parameter'%}
    <!-- Lattice parameters require special treatment -->
    {% for series in dataset.dataseries_set.all %}
      <div class="card">
        <div class="card-header">
          {% if dataset.dataseries_set.all.count > 1 %}
            Series #{{ forloop.counter }}{% if series.label %} - {{ series.label }}{% endif %}
          {% else %}
            Data
          {% endif %}
        </div>
        <div class="card-body">
          <!-- Lattice constants -->
          <table class="table-lattice-constants">
            {% for symbol, value, unit in series.get_lattice_constants %}
              <tr><td>{{ symbol }}:</td><td>{{ value }}{{ unit }}</td></tr>
            {% endfor %}
          </table>
          <!-- Atomic coordinates (optional) -->
          {% if series.datapoints.all.count > 6 %}
            <div class="text-center">
              <button class="text-center btn btn-default expand-hide-button" data-toggle="collapse"
                      data-target="#lattice-parameters-body-{{ series.pk }}">
                Atomic coordinates (click to expand)
              </button>
            </div>
            <div class="collapse" id="lattice-parameters-body-{{ series.pk }}"></div>
          {% endif %}
          {% if series.fixed_values.exists %}
            Fixed parameters:
            <ul style="margin-bottom:0;">
              {% for property, value, unit in series.get_fixed_values %}
                <li>{{ property }} = {{ value }} {{ unit }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% elif dataset.plotted %}
    <!-- Plotted data -->
    <canvas id="figure_{{ dataset.pk }}" width="400" height="300"></canvas>
  {% else %}
    <!-- Tabulated data -->
    {% for series in dataset.dataseries_set.all %}
      <div class="card">
        <div class="card-header">
          {% if dataset.dataseries_set.all.count > 1 %}
            Series #{{ forloop.counter }}{% if series.label %} - {{ series.label }}{% endif %}
          {% else %}
            Data
          {% endif %}
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <thead>
              <tr>
                {% if dataset.secondary_property %}
                  <th>
                    {{ dataset.secondary_property }}{% if dataset.secondary_unit %},
                    {{ dataset.secondary_unit }}{% endif %}
                  </th>
                {% endif %}
                <th>
                  {{ dataset.primary_property }}{% if dataset.primary_unit %},
                  {{ dataset.primary_unit }}{% endif %}
                </th>
              </tr>
            </thead>
            <tbody class="tabulated-data" id="table-{{ series.pk }}"></tbody>
          </table>
          {% if series.fixed_values.exists %}
            Fixed parameters:
            <ul style="margin-bottom:0;">
              {% for property, value, unit in series.get_fixed_values %}
                <li>{{ property }} = {{ value }} {{ unit }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% endif %}

  <!-- SYSTEM DESCRIPTION -->
  <div class="card">
    <div class="card-header">
      System description
    </div>
    <div class="card-body">
      Dimensionality: {{ dataset.dimensionality }}D<br>
      Sample type: {{ dataset.get_sample_type_display }}<br>
      Crystal system: {{ dataset.get_crystal_system_display }}
    </div>
  </div>

  <!-- SYNTHESIS METHOD -->
  {% if dataset.synthesis.exists %}
    <div class="card">
      <button class="btn text-left expand-hide-button"
              data-toggle="collapse"
              data-target="#synthesis-body-{{ dataset.pk }}">
        Synthesis method (click to expand)
      </button>
      <div class="collapse" id="synthesis-body-{{ dataset.pk }}">
        <div class="card-body">
          {% with dataset.synthesis.first as synthesis %}
            {% if synthesis.starting_materials %}
              <p>Starting materials: {{ synthesis.starting_materials }}</p>
            {% endif %}
            {% if synthesis.product %}
              <p>Product: {{ synthesis.product }}</p>
            {% endif %}
            {% if synthesis.description %}
              <p>Description: {{ synthesis.description }}</p>
            {% endif %}
            {% if synthesis.comment %}
              <p><i>Comment: {{ synthesis.comment }}</i></p>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
  {% endif %}

  <!-- EXPERIMENTAL DETAILS -->
  {% if dataset.experimental.exists %}
    <div class="card">
      <button class="btn text-left expand-hide-button"
              data-toggle="collapse"
              data-target="#experimental-body-{{ dataset.pk }}">
        Experimental details (click to expand)
      </button>
      <div class="collapse" id="experimental-body-{{ dataset.pk }}">
        <div class="card-body">
          {% with dataset.experimental.first as exp %}
            {% if exp.method %}
              <p>Method: {{ exp.method }}</p>
            {% endif %}
            {% if exp.description %}
              <p>Description: {{ exp.description }}</p>
            {% endif %}
            {% if exp.comment %}
              <p><i>Comment: {{ exp.comment }}</i></p>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
  {% endif %}

  <!-- COMPUTATIONAL DETAILS -->
  {% if dataset.computational.exists %}
    <div class="card">
      <button class="btn text-left expand-hide-button"
              data-toggle="collapse"
              data-target="#computational-body-{{ dataset.pk }}">
        Computational details (click to expand)
      </button>
      <div class="collapse" id="computational-body-{{ dataset.pk }}">
        <div class="card-body">
          {% with dataset.computational.first as comp %}
            {% if comp.code %}
              <p>Code: {{ comp.code }}</p>
            {% endif %}
            {% if comp.level_of_theory %}
              <p>Level of theory:
                {{ comp.level_of_theory }}</p>
            {% endif %}
            {% if comp.xc_functional %}
              <p>Exchange-correlation functional: {{ comp.xc_functional }}</p>
            {% endif %}
            {% if comp.kgrid %}
              <p>K-point grid: {{ comp.kgrid }}</p>
            {% endif %}
            {% if comp.relativity_level %}
              <p>Level of relativity: {{ comp.relativity_level }}</p>
            {% endif %}
            {% if comp.basis %}
              <p>Basis set definition: {{ comp.basis }}</p>
            {% endif %}
            {% if comp.numerical_accuracy %}
              <p>Numerical accuracy: {{ comp.numerical_accuracy }}</p>
            {% endif %}
            {% if comp.comment %}
              <p><i>Comment: {{ comp.comment }}</i></p>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
  {% endif %}

  <!-- REFERENCE -->
  {% if with_reference and dataset.reference %}
    <div class="card">
      <button class="btn text-left expand-hide-button" data-toggle="collapse"
              data-target="#reference-body-{{ dataset.pk }}">
        Reference (click to expand)
      </button>
      <div class="collapse" id="reference-body-{{ dataset.pk }}">
        <div class="card-body">
          {% include 'materials/reference_format.html' with ref=dataset.reference %}
        </div>
        <p class="text-center">
          <a href="{% url 'materials:reference' pk=dataset.reference.pk %}">
            <button class="btn btn-primary">All data for this reference</button>
          </a>
        </p>
      </div>
    </div>
  {% endif %}

  <!-- META -->
  <div class="card">
    <button class="btn text-left expand-hide-button" data-toggle="collapse"
            data-target="#meta-body-{{ dataset.pk }}">
      Meta (click to expand)
    </button>
    <div class="collapse" id="meta-body-{{ dataset.pk }}">
      <div class="card-body">
        {% if dataset.extraction_method %}
          Extraction method: {{ dataset.extraction_method }}<br>
        {% endif %}
        Entry added on {{ dataset.created }}<br>
        Last updated on {{ dataset.updated }}<br>
      </div>
    </div>
  </div>

  <!-- UPLOADED FILES -->
  {% if dataset.files.exists %}
    <br>
    <p>
      <a href="{% url "materials:download_dataset_files" pk=dataset.pk %}">
        <button type="button" class="btn btn-primary">
          <span class="fa fa-download" aria-hidden="true"></span>
          Files
        </button>
      </a>
      <i class="fa fa-question-circle tooltip-container">
        <span class="tooltiptext">Files containing anything that is relevant to the current data set (input files to a calculation, image of the sample, ...)</span>
      </i>
    </p>
  {% endif %}

  <!-- BUTTON FOR VIEWING ALL ENTRIES -->
  {% if with_all_entries and dataset.primary_property.pk %}
    {% with dataset.num_all_entries as num %}
      {% if num > 1 %}
        <p class="text-center m-1">
          <a href="{% url 'materials:property_all_entries' system_pk=dataset.system.pk prop_pk=dataset.primary_property.pk %}">
            See all entries for this property ({{ num }} total)
          </a>
        </p>
      {% endif %}
    {% endwith %}
  {% endif %}

  <div class="text-center"><strong>Dataset ID: {{ dataset.pk }}</strong></div>
</div>
