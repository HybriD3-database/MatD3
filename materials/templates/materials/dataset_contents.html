{% load materials_tags %}

{% comment %}
Contents of class="card-body" corresponding to a data set. Not all
sections are included by default. This file should be included using
the "with ..." syntax to include certain parts.
{% endcomment %}

<!-- MAIN DATA -->
<h5>{{ dataset.label }}</h5>
<h5>Origin: {% if dataset.is_experimental %}experimental{% else %}computational{% endif %}
  {{ dataset.get_all_fixed_temperatures }}
</h5>
{% if dataset.primary_property.name == 'atomic structure' %}
  {# Atomic structures require special treatment #}
  {% for subset in dataset.subsets.all %}
    <div class="card">
      <div class="card-header">
        Lattice parameters
        {% if dataset.subsets.count > 1 %}
          #{{ forloop.counter }}{% if subset.label %} - {{ subset.label }}{% endif %}
        {% endif %}
      </div>
      <div class="card-body">
        <!-- Lattice constants -->
        <table class="table-lattice-constants">
          {% for symbol, value, unit in subset.get_lattice_constants %}
            <tr><td>{{ symbol }}:</td><td>{{ value }}{{ unit }}</td></tr>
          {% endfor %}
        </table>
        <!-- Atomic coordinates (optional) -->
        {% if subset.datapoints.count > 6 and not skip_atomic_structure %}
          <div class="text-center">
            <button class="text-center btn btn-default expand-hide-button" data-toggle="collapse"
                    data-target="#atomic-coordinates-body-{{ subset.pk }}">
              Atomic coordinates (click to expand)
            </button>
          </div>
          <div class="collapse" id="atomic-coordinates-body-{{ subset.pk }}"></div>
        {% endif %}
        {% if subset.fixed_values.exists %}
          Fixed parameters:
          <ul style="margin-bottom:0;">
            {% for property, value, unit in subset.get_fixed_values %}
              <li>{{ property }} = {{ value }} {{ unit }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
      <footer class="reference">
        {% include 'materials/reference_format.html' with ref=dataset.reference %}
      </footer>
    </div>
  {% endfor %}
{% elif dataset.primary_property.name == 'band structure' %}
  {# Band structures require special treatment #}
  {% with subset=dataset.subsets.first %}
    <div class="card">
      <div class="card-header">
        {{ dataset.primary_property|capfirst }}
      </div>
      <div class="card-body">
        <ul class="nav nav-tabs" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" data-toggle="tab" role="tab"
               href="#band-structure-full-{{ dataset.pk }}">
              Full image
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-toggle="tab" role="tab"
               href="#band-structure-small-{{ dataset.pk }}">
              Zoomed
            </a>
          </li>
        </ul>
        <div class="tab-content" id="add-results-tab-content">
          <div class="tab-pane show active" id="band-structure-full-{{ dataset.pk }}" role="tabpanel">
            <img class="img-fluid"
                 src="/media/uploads/dataset_{{ dataset.pk }}/band_structure_full.png">
          </div>
          <div class="tab-pane" id="band-structure-small-{{ dataset.pk }}" role="tabpanel">
            <img class="img-fluid"
                 src="/media/uploads/dataset_{{ dataset.pk }}/band_structure_small.png">
          </div>
        </div>
        {% if subset.fixed_values.exists %}
          Fixed parameters:
          <ul style="margin-bottom:0;">
            {% for property, value, unit in subset.get_fixed_values %}
              <li>{{ property }} = {{ value }} {{ unit }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
      <footer class="reference">
        {% include 'materials/reference_format.html' with ref=dataset.reference %}
      </footer>
    </div>
  {% endwith %}
{% elif dataset.is_figure %}
  {# Plotted data #}
  <canvas id="figure_{{ dataset.pk }}" width="400" height="300"></canvas>
  <footer class="reference">
    {% include 'materials/reference_format.html' with ref=dataset.reference %}
  </footer>
{% else %}
  {# Tabulated data #}
  {% for subset in dataset.subsets.all %}
    <div class="card">
      <div class="card-header">
        {{ dataset.primary_property|capfirst }}
        {% if dataset.subsets.count > 1 %}
          #{{ forloop.counter }}{% if subset.label %} - {{ subset.label }}{% endif %}
        {% endif %}
      </div>
      <div class="card-body">
        <table class="table table-sm">
          <thead>
            <tr>
              {% if dataset.secondary_property %}
                <th>
                  {{ dataset.secondary_property|capfirst }}{% if dataset.secondary_unit %},
                  {{ dataset.secondary_unit }}{% endif %}
                </th>
              {% endif %}
              <th>
                {{ dataset.primary_property|capfirst }}{% if dataset.primary_unit %},
                {{ dataset.primary_unit }}{% endif %}
              </th>
            </tr>
          </thead>
          <tbody class="tabulated-data" id="table-{{ subset.pk }}"></tbody>
        </table>
        {% if subset.fixed_values.exists %}
          Fixed parameters:
          <ul style="margin-bottom:0;">
            {% for property, value, unit in subset.get_fixed_values %}
              <li>{{ property }} = {{ value }} {{ unit }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
      <footer class="reference">
        {% include 'materials/reference_format.html' with ref=dataset.reference %}
      </footer>
    </div>
  {% endfor %}
{% endif %}

<!-- SYSTEM DESCRIPTION -->
<div class="card">
  <div class="card-header">
    System description
  </div>
  <div class="card-body">
    <strong>Dimensionality:</strong> {{ dataset.dimensionality }}D<br>
    <strong>Sample type:</strong> {{ dataset.get_sample_type_display }}<br>
    <strong>Crystal system:</strong> {{ dataset.get_crystal_system_display }}
  </div>
</div>

<!-- LINKED DATA -->
{% if dataset.linked_to.exists %}
  <div class="card">
    <div class="card-header">
      Related data
    </div>
    <div class="card-body">
      This data set is directly linked to other data sets:
      <ul>
        {% for linked_set in dataset.linked_to.all %}
          <li>
            <a href="{% url 'materials:dataset' pk=linked_set.pk %}">
              data set {{ linked_set.pk }} ({{ linked_set.primary_property.name }})
            </a>
          </li>
        {% endfor %}
      </ul>
      <a href="{% url 'materials:linked_data' pk=dataset.pk %}">See all related data</a>
    </div>
  </div>
{% endif %}

<!-- SYNTHESIS METHOD -->
{% if dataset.synthesis.exists %}
  <div class="card">
    <button class="btn text-left expand-hide-button"
            data-toggle="collapse"
            data-target="#synthesis-body-{{ dataset.pk }}">
      Synthesis method (click to expand)
    </button>
    <div class="collapse" id="synthesis-body-{{ dataset.pk }}">
      <div class="card-body">
        {% with dataset.synthesis.first as synthesis %}
          {% if synthesis.starting_materials %}
            <p><strong>Starting materials:</strong> {{ synthesis.starting_materials }}</p>
          {% endif %}
          {% if synthesis.product %}
            <p><strong>Product:</strong> {{ synthesis.product }}</p>
          {% endif %}
          {% if synthesis.description %}
            <p><strong>Description:</strong> {{ synthesis.description }}</p>
          {% endif %}
          {% if synthesis.comment %}
            <p><i><strong>Comment:</strong></i> {{ synthesis.comment }}</i></p>
          {% endif %}
        {% endwith %}
      </div>
    </div>
  </div>
{% endif %}

<!-- EXPERIMENTAL DETAILS -->
{% if dataset.experimental.exists %}
  <div class="card">
    <button class="btn text-left expand-hide-button"
            data-toggle="collapse"
            data-target="#experimental-body-{{ dataset.pk }}">
      Experimental details (click to expand)
    </button>
    <div class="collapse" id="experimental-body-{{ dataset.pk }}">
      <div class="card-body">
        {% with dataset.experimental.first as exp %}
          {% if exp.method %}
            <p><strong>Method:</strong> {{ exp.method }}</p>
          {% endif %}
          {% if exp.description %}
            <p><strong>Description:</strong> {{ exp.description }}</p>
          {% endif %}
          {% if exp.comment %}
            <p><i><strong>Comment:</strong> {{ exp.comment }}</i></p>
          {% endif %}
        {% endwith %}
      </div>
    </div>
  </div>
{% endif %}

<!-- COMPUTATIONAL DETAILS -->
{% if dataset.computational.exists %}
  <div class="card">
    <button class="btn text-left expand-hide-button"
            data-toggle="collapse"
            data-target="#computational-body-{{ dataset.pk }}">
      Computational details (click to expand)
    </button>
    <div class="collapse" id="computational-body-{{ dataset.pk }}">
      <div class="card-body">
        {% with dataset.computational.first as comp %}
          {% if comp.code %}
            <p><strong>Code:</strong> {{ comp.code }}</p>
          {% endif %}
          {% if comp.level_of_theory %}
            <p><strong>Level of theory:</strong>
              {{ comp.level_of_theory }}</p>
          {% endif %}
          {% if comp.xc_functional %}
            <p><strong>Exchange-correlation functional:</strong> {{ comp.xc_functional }}</p>
          {% endif %}
          {% if comp.kgrid %}
            <p><strong>K-point grid:</strong> {{ comp.kgrid }}</p>
          {% endif %}
          {% if comp.relativity_level %}
            <p><strong>Level of relativity:</strong> {{ comp.relativity_level }}</p>
          {% endif %}
          {% if comp.basis %}
            <p><strong>Basis set definition:</strong> {{ comp.basis }}</p>
          {% endif %}
          {% if comp.numerical_accuracy %}
            <p><strong>Numerical accuracy:</strong> {{ comp.numerical_accuracy }}</p>
          {% endif %}
          {% with dataset.get_geometry_file_location as location %}
            {% if location %}
              <p><a href="{{ location }}">Geometry used in the calculation</a></p>
            {% endif %}
          {% endwith %}
          {% if comp.comment %}
            <p><i><strong>Comment:</strong> {{ comp.comment }}</i></p>
          {% endif %}
        {% endwith %}
      </div>
    </div>
  </div>
{% endif %}

<!-- REFERENCE -->
{% if with_reference and dataset.reference %}
  <div class="card">
    <button class="btn text-left expand-hide-button" data-toggle="collapse"
            data-target="#reference-body-{{ dataset.pk }}">
      Reference (click to expand)
    </button>
    <div class="collapse" id="reference-body-{{ dataset.pk }}">
      <div class="card-body">
        {% include 'materials/reference_format.html' with ref=dataset.reference %}
      </div>
      <p class="text-center">
        <a href="{% url 'materials:reference' pk=dataset.reference.pk %}">
          <button class="btn btn-primary">All data for this reference</button>
        </a>
      </p>
    </div>
  </div>
{% endif %}

<!-- META -->
<div class="card">
  <button class="btn text-left expand-hide-button" data-toggle="collapse"
          data-target="#meta-body-{{ dataset.pk }}">
    Meta (click to expand)
  </button>
  <div class="collapse" id="meta-body-{{ dataset.pk }}">
    <div class="card-body">
      {% if dataset.extraction_method %}
        <strong>Extraction method:</strong> {{ dataset.extraction_method }}<br>
      {% endif %}
      <strong>Entry added:</strong> {{ dataset.created }}<br>
      <strong>Last updated:</strong> {{ dataset.updated }}<br>
    </div>
  </div>
</div>

<!-- UPLOADED FILES -->
{% if dataset.files.exists %}
  <br>
  <p>
    <a href="{% url "materials:dataset_files" pk=dataset.pk %}">
      <button type="button" class="btn btn-primary">
        <span class="fa fa-download" aria-hidden="true"></span>
        Uploaded files
      </button>
    </a>
    <i class="fa fa-question-circle tooltip-container">
      <span class="tooltiptext">Files containing anything that is relevant to the current data (input files to a calculation, image of the sample, ...)</span>
    </i>
  </p>
{% endif %}

<!-- BUTTON FOR VIEWING ALL ENTRIES -->
{% if with_all_entries and dataset.primary_property.pk %}
  {% with dataset.num_all_entries as num %}
    {% if num > 1 %}
      <p class="text-center m-1">
        <a href="{% url 'materials:property_all_entries' system_pk=dataset.system.pk prop_pk=dataset.primary_property.pk %}">
          See all entries for this property ({{ num }} total)
        </a>
      </p>
    {% endif %}
  {% endwith %}
{% endif %}

<div class="text-center" style="margin-top:10px">
  <strong style="margin-right:10px">Data set ID: {{ dataset.pk }}</strong>
  <button type="button" class="btn btn-info btn-sm" data-toggle="collapse"
          data-target="#issue-report-{{ dataset.pk }}">
    Report an issue
  </button>
  <i class="fa fa-question-circle tooltip-container">
    <span class="tooltiptext">Did you find any mistakes or inconsistencies about this data? If so, send us a note and we'll have a look at it and send you a reply. Thanks!</span>
  </i>
</div>

<div class="collapse issue-report" id="issue-report-{{ dataset.pk }}">
  <form method="post" action="{% url 'materials:report_issue' %}">
    {% csrf_token %}
    <div class="form-group">
      <label for="issue-report-contents-{{ dataset.pk }}">Description</label>
      {% if user.is_authenticated %}
        <textarea class="form-control" id="issue-report-contents-{{ dataset.pk }}"
                  name="description" required
                  placeholder="Anything you would like to draw our attention to"></textarea>
      {% else %}
        <textarea class="form-control" id="issue-report-contents-{{ dataset.pk }}"
                  name="description" required disabled
                  placeholder="You must be logged in to perform this action."></textarea>
      {% endif %}
    </div>
    <input type="hidden" name="pk" value="{{ dataset.pk }}">
    <input type="hidden" name="return-path" value="{{ request.path }}">
    {% if user.is_authenticated %}
      <button type="submit" class="btn btn-primary btn-sm"">Submit</button>
    {% endif %}
  </form>
</div>
